// 1. Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø°ÙŠ Ø­Ø¯Ø¯ØªÙÙ‡ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¬ÙŠÙ†ÙƒÙŠÙ†Ø²
@Library('my-shared-library') _

pipeline {
    agent any

    environment {
        // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹
        IMAGE_NAME = "nourhanosma47/my-app-image:${env.BUILD_ID}"
        DOCKER_HUB_CREDS = "docker-hub-credentials-id" // ØªØ£ÙƒØ¯ÙŠ Ù…Ù† Ø§Ù„Ù€ ID ÙÙŠ Ø¬ÙŠÙ†ÙƒÙŠÙ†Ø²
        DEPLOYMENT_FILE = "deployment.yaml"
    }

    stages {
        stage('Unit Test ğŸ§ª') {
            steps {
                runUnitTest() 
            }
        }

        stage('Build Artifact ğŸ—ï¸') {
            steps {
                buildApp()
            }
        }

        stage('Docker Build ğŸ³') {
            steps {
                // Ù†Ù…Ø±Ø± Ø§Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒÙ€ Parameter Ù„Ù„Ø¯Ø§Ù„Ø©
                buildImage(IMAGE_NAME)
            }
        }

        stage('Security Scan ğŸ”') {
            steps {
                scanImage(IMAGE_NAME)
            }
        }

        stage('Push to DockerHub ğŸš€') {
            steps {
                // Ù†Ù…Ø±Ø± Ø§Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© ÙˆÙ…Ø¹Ø±Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯
                pushImage(IMAGE_NAME, DOCKER_HUB_CREDS)
            }
        }

        stage('Cleanup ğŸ§¹') {
            steps {
                removeImage(IMAGE_NAME)
            }
        }

        stage('Deploy to K8s â›µ') {
            steps {
                // Ù†Ù…Ø±Ø± Ø§Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© ÙˆÙ…Ù„Ù Ø§Ù„Ù€ YAML
                deployOnK8s(IMAGE_NAME, DEPLOYMENT_FILE)
            }
        }
    }
}
