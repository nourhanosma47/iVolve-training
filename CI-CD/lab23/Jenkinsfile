@Library('my-shared-library') _

pipeline {
    agent any
    tools {
        maven 'maven-3'
        dockerTool 'Docker'
    }
    environment {
        DOCKER_HUB_CREDS = "docker-hub-credentials-id"
        K8S_CREDS_ID     = "kubeconfig-id" // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù€ ID Ù‡Ù†Ø§ Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹ ğŸ”‘
        IMAGE_NAME       = "nourhanosama/my-app:${env.BUILD_ID}" 
        DEPLOYMENT_FILE  = "CI-CD/lab23/deployment.yaml"
    }

    stages {
        stage('Checkout ğŸ›°ï¸') {
            steps {
                checkout([$class: 'GitSCM', 
                    branches: scm.branches,
                    userRemoteConfigs: scm.userRemoteConfigs,
                    extensions: [[$class: 'CheckoutOption', timeout: 20], 
                                 [$class: 'CloneOption', timeout: 20]]
                ])
            }
        }

        stage('Project Operations') {
            steps {
                dir('CI-CD/lab23') {
                    script {
                        stage('Unit Test ğŸ§ª') {
                            runUnitTest()
                        }
                        stage('Build Artifact ğŸ—ï¸') {
                            buildApp()
                        }
                        stage('Docker Build ğŸ³') {
                            withCredentials([usernamePassword(credentialsId: DOCKER_HUB_CREDS, passwordVariable: 'DOCKER_PASS', usernameVariable: 'DOCKER_USER')]) {
                                sh "echo \$DOCKER_PASS | docker login -u \$DOCKER_USER --password-stdin"
                                buildImage(IMAGE_NAME)
                            }
                        }
                        stage('Security Scan ğŸ”') {
                            try {
                                scanImage(IMAGE_NAME)
                            } catch (Exception e) {
                                echo "ØªÙ†Ø¨ÙŠÙ‡: Ø£Ø¯Ø§Ø© Trivy ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø³ÙŠØªÙ… ØªØ®Ø·ÙŠ Ø§Ù„ÙØ­Øµ Ø­Ø§Ù„ÙŠØ§Ù‹."
                            }
                        }
                        stage('Push to DockerHub ğŸš€') {
                            pushImage(IMAGE_NAME, DOCKER_HUB_CREDS)
                        }
                    }
                }
            }
        }

        stage('Deploy to K8s â›µ') {
            steps {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ØªÙŠ Ø£Ø¶ÙÙ†Ø§Ù‡Ø§ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Jenkins
                withKubeConfig([credentialsId: "${env.K8S_CREDS_ID}"]) { 
                    echo "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ù…Ù„Ù Ø§Ù„Ù€ YAML Ø¥Ù„Ù‰: ${IMAGE_NAME} ğŸ”„"
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ Ù…Ù„Ù Ø§Ù„Ù€ deployment Ù‚Ø¨Ù„ Ø§Ù„ØªÙ†ÙÙŠØ°
                    sh "sed -i 's|image:.*|image: ${IMAGE_NAME}|g' ${env.DEPLOYMENT_FILE}"
                    
                    echo "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ Kubernetes â›µ"
                    sh "kubectl apply -f ${env.DEPLOYMENT_FILE}"
                    
                    // Ø®Ø·ÙˆØ© Ø¥Ø¶Ø§ÙÙŠØ©: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø±
                    sh "kubectl rollout status deployment/my-app-deployment" 
                }
            }
        }

        stage('Cleanup ğŸ§¹') {
            steps {
                removeImage(IMAGE_NAME)
            }
        }
    }
}
