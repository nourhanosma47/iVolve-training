@Library('my-shared-library') _

pipeline {
    agent any

    environment {
        // ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ ID Ù‡Ù†Ø§ Ù„ÙŠØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ù…Ø§ Ù„Ø¯ÙŠÙƒÙ ÙÙŠ Ø¬ÙŠÙ†ÙƒÙŠÙ†Ø²
        DOCKER_HUB_CREDS = "docker-hub-credentials-id"
        IMAGE_NAME = "nourhanosma47/my-app:${env.BUILD_ID}"
        DEPLOYMENT_FILE = "CI-CD/lab23/deployment.yaml"
    }

    stages {
        stage('Checkout ğŸ›°ï¸') {
            steps {
                // Ø¥Ø¶Ø§ÙØ© Timeout Ù„Ø¹Ù…Ù„ÙŠØ© Ø³Ø­Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ù„ØªØ¬Ù†Ø¨ Ø®Ø·Ø£ RPC failed
                checkout([$class: 'GitSCM', 
                    branches: scm.branches,
                    userRemoteConfigs: scm.userRemoteConfigs,
                    extensions: [[$class: 'CheckoutOption', timeout: 20], 
                                 [$class: 'CloneOption', timeout: 20]]
                ])
            }
        }

        stage('Unit Test ğŸ§ª') {
            steps {
                runUnitTest()
            }
        }

        stage('Build Artifact ğŸ—ï¸') {
            steps {
                buildApp()
            }
        }

        stage('Docker Build ğŸ³') {
            steps {
                buildImage(IMAGE_NAME)
            }
        }

        stage('Security Scan ğŸ”') {
            steps {
                scanImage(IMAGE_NAME)
            }
        }

        stage('Push to DockerHub ğŸš€') {
            steps {
                pushImage(IMAGE_NAME, DOCKER_HUB_CREDS)
            }
        }

        stage('Cleanup ğŸ§¹') {
            steps {
                removeImage(IMAGE_NAME)
            }
        }

        stage('Deploy to K8s â›µ') {
            steps {
                deployOnK8s(IMAGE_NAME, DEPLOYMENT_FILE)
            }
        }
    }
}
