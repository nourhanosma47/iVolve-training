@Library('my-shared-library') _

pipeline {
    agent any
    tools {
        maven 'maven-3'
        dockerTool 'Docker'
    }
    environment {
        DOCKER_HUB_CREDS = "docker-hub-credentials-id"
        IMAGE_NAME = "nourhanosma47/my-app:${env.BUILD_ID}"
        DEPLOYMENT_FILE = "CI-CD/lab23/deployment.yaml"
    }

    stages {
        stage('Checkout ğŸ›°ï¸') {
            steps {
                checkout([$class: 'GitSCM', 
                    branches: scm.branches,
                    userRemoteConfigs: scm.userRemoteConfigs,
                    extensions: [[$class: 'CheckoutOption', timeout: 20], 
                                 [$class: 'CloneOption', timeout: 20]]
                ])
            }
        }

        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ù„ÙˆÙƒ ÙˆØ§Ø­Ø¯ Ù„ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
        stage('Project Operations') {
            steps {
                dir('CI-CD/lab23') {
                    script {
                        stage('Unit Test ğŸ§ª') {
                            runUnitTest()
                        }
                        stage('Build Artifact ğŸ—ï¸') {
                            buildApp()
                        }
                        stage('Docker Build ğŸ³') {
                            buildImage(IMAGE_NAME)
                        }
                        stage('Security Scan ğŸ”') {
                            scanImage(IMAGE_NAME)
                        }
                        stage('Push to DockerHub ğŸš€') {
                            pushImage(IMAGE_NAME, DOCKER_HUB_CREDS)
                        }
                    }
                }
            }
        }

        stage('Cleanup ğŸ§¹') {
            steps {
                removeImage(IMAGE_NAME)
            }
        }

        stage('Deploy to K8s â›µ') {
            steps {
                // Ù†Ù…Ø±Ø± Ù…Ø³Ø§Ø± Ù…Ù„Ù Ø§Ù„Ù€ yaml Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙƒÙ…Ø§ Ù‡Ùˆ Ù…Ø¹Ø±Ù ÙÙŠ Ø§Ù„Ù€ environment
                deployOnK8s(IMAGE_NAME, DEPLOYMENT_FILE)
            }
        }
    }
}
