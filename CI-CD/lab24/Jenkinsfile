@Library('my-shared-library') _

pipeline {
    // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù€ Slave (Ø§Ø³ØªØ¨Ø¯Ù„ÙŠ 'your-slave-label' Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Nodes)
    agent { label 'your-slave-label' } 

    tools {
        maven 'maven-3'
        dockerTool 'Docker'
    }
    
    environment {
        DOCKER_HUB_CREDS = "docker-hub-credentials-id"
        K8S_CREDS_ID     = "kubeconfig-id" 
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹ ÙÙŠ Ø§Ù„ØªØ§Ø¬ Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„ØµÙˆØ± (dev/stag/prod)
        IMAGE_NAME       = "nourhanosama/my-app:${env.BRANCH_NAME}-${env.BUILD_ID}" 
        
        DEPLOYMENT_FILE  = "CI-CD/lab23/deployment.yaml"
        SERVICE_FILE     = "CI-CD/lab23/service.yaml"
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù€ Namespace ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹
        K8S_NAMESPACE    = "${env.BRANCH_NAME}"
    }

    stages {
        stage('Checkout ğŸ›°ï¸') {
            steps {
                // Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                checkout scm 
            }
        }

        stage('Project Operations') {
            steps {
                dir('CI-CD/lab23') {
                    script {
                        stage('Unit Test ğŸ§ª') {
                            runUnitTest()
                        }
                        stage('Build Artifact ğŸ—ï¸') {
                            buildApp()
                        }
                        stage('Docker Build & Push ğŸ³') {
                            withCredentials([usernamePassword(credentialsId: DOCKER_HUB_CREDS, passwordVariable: 'DOCKER_PASS', usernameVariable: 'DOCKER_USER')]) {
                                sh "echo \$DOCKER_PASS | docker login -u \$DOCKER_USER --password-stdin"
                                buildImage(IMAGE_NAME)
                                pushImage(IMAGE_NAME, DOCKER_HUB_CREDS)
                            }
                        }
                    }
                }
            }
        }

        stage('Deploy to K8s â›µ') {
            steps {
                withKubeConfig([credentialsId: "${env.K8S_CREDS_ID}"]) { 
                    echo "Deploying to Namespace: ${K8S_NAMESPACE} ğŸ—ï¸"
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ Ù…Ù„Ù Ø§Ù„Ù€ deployment Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… sed
                    sh "sed -i 's|image:.*|image: ${IMAGE_NAME}|g' ${env.DEPLOYMENT_FILE}"
                    
                    // Ø§Ù„Ù†Ø´Ø± ÙÙŠ Ø§Ù„Ù€ Namespace Ø§Ù„Ù…Ø­Ø¯Ø¯ (-n)
                    sh "kubectl apply -f ${env.DEPLOYMENT_FILE} -n ${K8S_NAMESPACE} --insecure-skip-tls-verify"
                    sh "kubectl apply -f ${env.SERVICE_FILE} -n ${K8S_NAMESPACE} --insecure-skip-tls-verify"
                    
                    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                    sh "kubectl rollout status deployment/jenkins-app -n ${K8S_NAMESPACE} --insecure-skip-tls-verify" 
                }
            }
        }

        stage('Cleanup ğŸ§¹') {
            steps {
                removeImage(IMAGE_NAME)
            }
        }
    }
}
