@Library('my-shared-library') _

pipeline {
    agent { label 'slave-vm' } 

    environment {
        DOCKER_HUB_CREDS = "docker-hub-credentials-id" 
        K8S_CREDS_ID     = "kubeconfig-id" 
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹ ÙˆØ±Ù‚Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„ØµÙˆØ±Ø©
        CURRENT_BRANCH   = "${env.BRANCH_NAME ?: 'main'}"
        IMAGE_NAME       = "nourhanosama/jenkins-app:${env.BRANCH_NAME}-${env.BUILD_ID}" 
        
        // ØªØ­Ø¯ÙŠØ¯ Ù…Ø³Ø§Ø±Ø§Øª Ù…Ù„ÙØ§Øª Kubernetes (Ù†Ø³Ø¨Ø©Ù‹ Ù„Ù…Ø¬Ù„Ø¯ lab24)
        DEPLOYMENT_FILE  = "deployment.yaml"
        SERVICE_FILE     = "service.yaml"
        
        K8S_NAMESPACE    = "${env.BRANCH_NAME}"
    }

    stages {
        stage('Checkout ğŸ›°ï¸') {
            steps {
                checkout scm 
            }
        }

        stage('CI: Build & Test ğŸ§ª') {
            steps {
                script {
                    // Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ pom.xml Ùˆ Dockerfile
                    dir('CI-CD/lab24') { 
                        echo "Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØ¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚... ğŸ§ª"
                        runUnitTest()
                        buildApp()
                        
                        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‚Ø¨Ù„ Ø¨Ù†Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø© Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© 401 Unauthorized Ø¹Ù†Ø¯ Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                        withCredentials([usernamePassword(credentialsId: DOCKER_HUB_CREDS, passwordVariable: 'DOCKER_PASS', usernameVariable: 'DOCKER_USER')]) {
                            sh "echo \$DOCKER_PASS | docker login -u \$DOCKER_USER --password-stdin"
                            
                            echo "Ø¬Ø§Ø±ÙŠ Ø¨Ù†Ø§Ø¡ ØµÙˆØ±Ø© Docker... ğŸ³"
                            buildImage(IMAGE_NAME)
                            scanImage(IMAGE_NAME)
                        }
                    }
                }
            }
        }

        stage('Push to Registry ğŸš€') {
            steps {
                script {
                    // Ø§Ù„Ø±ÙØ¹ Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (Ø¨Ù…Ø§ Ø£Ù†Ù†Ø§ Ø³Ø¬Ù„Ù†Ø§ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©ØŒ Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„Ø±ÙØ¹ Ù…Ø¨Ø§Ø´Ø±Ø©)
                    echo "Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Docker Hub... ğŸš€"
                    pushImage(IMAGE_NAME, DOCKER_HUB_CREDS)
                }
            }
        }

        stage('CD: Deploy to K8s â›µ') {
            steps {
                script {
                    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù…Ø¬Ù„Ø¯ Ù…Ù„ÙØ§Øª Ø§Ù„Ù€ k8s Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¯Ø§Ø®Ù„ lab24
                    dir('CI-CD/lab24') {
                        withKubeConfig([credentialsId: "${env.K8S_CREDS_ID}"]) { 
                            sh "kubectl create namespace ${CURRENT_BRANCH} --dry-run=client -o yaml | kubectl apply -f - --insecure-skip-tls-verify"
            
                            echo "Deploying to Namespace: ${CURRENT_BRANCH} ğŸ—ï¸"
                            sh "sed -i 's|image:.*|image: ${IMAGE_NAME}|g' deployment.yaml"
                            // Ø§Ù„Ù†Ø´Ø± ÙÙŠ Ø§Ù„Ù€ Namespace Ø§Ù„Ù…Ø­Ø¯Ø¯
                            sh "kubectl apply -f ${env.DEPLOYMENT_FILE} -n ${K8S_NAMESPACE} --insecure-skip-tls-verify"
                            sh "kubectl apply -f ${env.SERVICE_FILE} -n ${K8S_NAMESPACE} --insecure-skip-tls-verify"
                            
                            sh "kubectl rollout status deployment/jenkins-app -n ${K8S_NAMESPACE} --insecure-skip-tls-verify"
                        }
                    }
                }
            }
        }

        stage('Cleanup ğŸ§¹') {
            steps {
                echo "ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø­Ù„ÙŠØ©... ğŸ§¹"
                removeImage(IMAGE_NAME)
            }
        }
    }
}
