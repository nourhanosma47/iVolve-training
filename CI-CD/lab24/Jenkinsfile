@Library('my-shared-library') _

pipeline {
    // 1. Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ Slave Ø§Ù„Ø°ÙŠ ØªØ£ÙƒØ¯Ù†Ø§ Ù…Ù† Ø§ØªØµØ§Ù„Ù‡ (slave-vm)
    agent { label 'slave-vm' } 

    environment {
        // ØªØ£ÙƒØ¯ÙŠ Ù…Ù† Ø£Ù† Ù‡Ø°Ù‡ Ø§Ù„Ù€ IDs Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù…Ø§ Ù‡Ùˆ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Jenkins Credentials
        DOCKER_HUB_CREDS = "docker-hub-credentials-id" 
        K8S_CREDS_ID     = "kubeconfig-id" 
        
        // ØªÙ…ÙŠÙŠØ² Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±Ø¹ ÙˆØ±Ù‚Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„ØªØ¯Ø§Ø®Ù„
        IMAGE_NAME       = "nourhanosama/jenkins-app:${env.BRANCH_NAME}-${env.BUILD_ID}" 
        
        // Ù…Ø³Ø§Ø±Ø§Øª Ù…Ù„ÙØ§Øª Kubernetes (ØªØ£ÙƒØ¯ÙŠ Ø£Ù†Ù‡Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù…Ø¬Ù„Ø¯ k8s Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ Repo)
        DEPLOYMENT_FILE  = "k8s/deployment.yaml"
        SERVICE_FILE     = "k8s/service.yaml"
        
        // Ø§Ù„Ù€ Namespace ÙŠØªØ­Ø¯Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (dev/stag/prod) Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
        K8S_NAMESPACE    = "${env.BRANCH_NAME}"
    }

    stages {
        stage('Checkout ğŸ›°ï¸') {
            steps {
                // Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
                checkout scm 
            }
        }

        stage('CI: Build & Test ğŸ§ª') {
            steps {
                script {
                    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…Ù† Ù…Ø¬Ù„Ø¯ vars ÙÙŠ Ù…ÙƒØªØ¨ØªÙƒ Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©
                    runUnitTest()
                    buildApp()
                    
                    // Ø¨Ù†Ø§Ø¡ ÙˆÙØ­Øµ Ø§Ù„ØµÙˆØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø±ÙØ¹
                    buildImage(IMAGE_NAME)
                    scanImage(IMAGE_NAME)
                }
            }
        }

        stage('Push to Registry ğŸš€') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: DOCKER_HUB_CREDS, passwordVariable: 'DOCKER_PASS', usernameVariable: 'DOCKER_USER')]) {
                        sh "echo \$DOCKER_PASS | docker login -u \$DOCKER_USER --password-stdin"
                        pushImage(IMAGE_NAME, DOCKER_HUB_CREDS)
                    }
                }
            }
        }

        stage('CD: Deploy to K8s â›µ') {
            steps {
                script {
                    withKubeConfig([credentialsId: "${env.K8S_CREDS_ID}"]) { 
                        echo "Deploying branch ${env.BRANCH_NAME} to Namespace: ${K8S_NAMESPACE} ğŸ—ï¸"
                        
                        // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ Ù…Ù„Ù Ø§Ù„Ù€ deployment
                        sh "sed -i 's|image:.*|image: ${IMAGE_NAME}|g' ${env.DEPLOYMENT_FILE}"
                        
                        // Ø§Ù„Ù†Ø´Ø± ÙÙŠ Ø§Ù„Ù€ Namespace Ø§Ù„Ù…Ø­Ø¯Ø¯ (-n)
                        sh "kubectl apply -f ${env.DEPLOYMENT_FILE} -n ${K8S_NAMESPACE} --insecure-skip-tls-verify"
                        sh "kubectl apply -f ${env.SERVICE_FILE} -n ${K8S_NAMESPACE} --insecure-skip-tls-verify"
                        
                        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù€ Deployment ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­
                        sh "kubectl rollout status deployment/jenkins-app -n ${K8S_NAMESPACE} --insecure-skip-tls-verify"
                    }
                }
            }
        }

        stage('Cleanup ğŸ§¹') {
            steps {
                // Ù…Ø³Ø­ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ Ù…Ù† Ø¹Ù„Ù‰ Ø§Ù„Ù€ Slave Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø­Ø©
                removeImage(IMAGE_NAME)
            }
        }
    }
}
