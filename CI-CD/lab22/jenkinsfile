pipeline {
    agent {
        docker {
            image 'maven:3.9.2-eclipse-temurin-11'  // Maven + JDK
            args '-v /var/run/docker.sock:/var/run/docker.sock'  // Docker inside Docker
        }
    }

    environment {
        DOCKERHUB_CREDENTIALS = credentials('dockerhub-id')  // Ø³Ø¬Ù„Ù‘ÙŠ Docker Hub credentials ÙÙŠ Jenkins
        IMAGE_NAME = 'nourhanosama/jenkins-app'
        IMAGE_TAG = "v${env.BUILD_NUMBER}"
    }

    stages {

        stage('Checkout') {
            steps {
                echo 'ğŸ”¹ Cloning repository...'
                git branch: 'main',
                    url: 'https://github.com/nourhanosma47/iVolve-training.git'
            }
        }

        stage('Run Unit Tests') {
            steps {
                echo 'ğŸ”¹ Running Maven Unit Tests...'
                sh 'mvn clean test'
            }
        }

        stage('Build Application') {
            steps {
                echo 'ğŸ”¹ Building Application...'
                sh 'mvn clean package'
            }
        }

        stage('Build Docker Image') {
            steps {
                echo "ğŸ”¹ Building Docker image: ${IMAGE_NAME}:${IMAGE_TAG}"
                sh "docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ."
            }
        }

        stage('Push Docker Image') {
            steps {
                echo 'ğŸ”¹ Pushing Docker image to Docker Hub...'
                sh """
                echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin
                docker push ${IMAGE_NAME}:${IMAGE_TAG}
                """
            }
        }

        stage('Delete Local Docker Image') {
            steps {
                echo 'ğŸ”¹ Deleting local Docker image...'
                sh "docker rmi ${IMAGE_NAME}:${IMAGE_TAG}"
            }
        }

        stage('Update Deployment YAML & Deploy') {
            steps {
                echo 'ğŸ”¹ Updating deployment.yaml with new image...'
                sh "sed -i 's|image:.*|image: ${IMAGE_NAME}:${IMAGE_TAG}|' k8s/deployment.yaml"
                echo 'ğŸ”¹ Deploying to Kubernetes cluster...'
                sh "kubectl apply -f k8s/deployment.yaml"
            }
        }
    }

    post {
        always {
            echo 'âœ… Pipeline finished (always runs)'
        }
        success {
            echo 'ğŸ‰ Pipeline succeeded!'
        }
        failure {
            echo 'âŒ Pipeline failed!'
        }
    }
}
